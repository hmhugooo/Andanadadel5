<!doctype html> 
<html lang="es"> 
<head> 
  <meta charset="UTF-8" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
  <title>Andanada del 5 — CMS</title> 
  <meta name="robots" content="noindex" /> 
  
  <style> 
    body { 
      margin: 0; 
      background: #0b0b0b; 
      color: #fff; 
      font-family: system-ui, -apple-system, sans-serif; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      height: 100vh; 
    } 
    .loader { 
      position: absolute; 
      opacity: 0.6; 
      font-size: 12px; 
      letter-spacing: 0.2em; 
      text-transform: uppercase; 
      z-index: 10;
      pointer-events: none;
      transition: opacity 0.5s ease;
    } 
    body.cms-ready .loader {
      opacity: 0;
    }
  </style> 
  <meta name="admin-build" content="v2-2026-02-25T12:34:56Z">
  <script>console.log("ADMIN BUILD v2", "2026-02-25T12:34:56Z");</script>
</head> 
<body>

  <div id="admin-debug" style="position:fixed;top:10px;right:10px;z-index:99999;background:#ff2a6d;color:#000;padding:8px 10px;border-radius:8px;font:12px/1.2 system-ui;">ADMIN BUILD v2 2026-02-25T12:34:56Z</div>

  <!-- Loader visual (capa superior) -->
  <div class="loader">Cargando panel editorial…</div> 

  <!-- Contenedor principal para Decap CMS -->
  <div id="nc-root"></div> 

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

  <!-- Identity Redirect Script -->
  <script> 
    if (window.netlifyIdentity) { 
      window.netlifyIdentity.on("init", user => { 
        if (!user) { 
          window.netlifyIdentity.on("login", () => { 
            document.location.href = "/admin/"; 
          }); 
        } 
      }); 
    } 
  </script> 

  <!-- Decap CMS Core -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script> 

  <!-- Custom Previews -->
  <script>
    if (typeof CMS !== 'undefined') {
      CMS.registerPreviewStyle("../assets/css/styles.css");
      CMS.registerPreviewStyle(`
        :root {
          --preview-bg: #f6f6f6;
        }
        body {
          background: var(--preview-bg);
        }
        .preview-root {
          max-width: 980px;
          margin: 0 auto;
          padding: 24px 16px 40px;
        }
      `, { raw: true });

      var PostPreview = createClass({
        render: function () {
          var entry = this.props.entry;
          var getAsset = this.props.getAsset;
          var title = entry.getIn(['data','title']) || '';
          var date = entry.getIn(['data','date']) || '';
          var category = entry.getIn(['data','category']) || '';
          var excerpt = entry.getIn(['data','excerpt']) || '';
          var imagePath = entry.getIn(['data','image']);
          var image = imagePath ? getAsset(imagePath) : null;
          return h('div', { className: 'preview-root' },
            h('article', { className: 'post-card' },
              h('a', { className: 'post-card__link', href: '#' },
                h('div', { className: 'post-card__media post-card__media--ratio' },
                  image ? h('picture', null,
                    h('img', {
                      className: 'post-card__image',
                      src: image.toString(),
                      alt: 'Imagen del artículo: ' + String(title)
                    })
                  ) :
                  h('div', { className: 'skeleton skeleton-block', style: { height: '240px', borderRadius: '12px' } })
                ),
                h('div', { className: 'post-card__body' },
                  h('p', { className: 'post-card__category' },
                    h('span', { className: 'badge badge--category' }, String(category))
                  ),
                  h('h2', { className: 'post-card__title' }, String(title)),
                  h('div', { className: 'post-card__meta' },
                    h('time', { dateTime: String(date) }, String(date ? new Date(date).toLocaleDateString('es-ES') : ''))
                  ),
                  h('p', { className: 'post-card__excerpt' }, String(excerpt || 'Añade una entradilla para ver aquí un avance del contenido.'))
                )
              )
            )
          );
        }
      });
      CMS.registerPreviewTemplate('posts', PostPreview);

      var AgendaPreview = createClass({
        render: function () {
          var entry = this.props.entry;
          var getAsset = this.props.getAsset;
          var items = entry.getIn(['data','items']) || [];
          var nodes = [];
          if (items && items.size) {
            items.forEach(function (it, idx) {
              var titulo = it.get('titulo') || '';
              var tipo = it.get('tipo') || '';
              var fecha = it.get('fecha') || '';
              var hora = it.get('hora') || '';
              var plaza = it.get('plaza') || '';
              var ciudad = it.get('ciudad') || '';
              var posterPath = it.get('poster');
              var poster = posterPath ? getAsset(posterPath) : null;
              nodes.push(
                h('article', { key: String(idx), className: 'post-card agenda-card', style: { marginBottom: '16px' } },
                  h('div', { className: 'post-card__link' },
                    h('div', { className: 'post-card__media post-card__media--ratio' },
                      poster ? h('picture', null,
                        h('img', {
                          className: 'post-card__image',
                          src: poster.toString(),
                          alt: 'Cartel: ' + String(titulo)
                        })
                      ) :
                      h('div', { className: 'agenda-poster-placeholder' }, 'Cartel pendiente')
                    ),
                    h('div', { className: 'post-card__body' },
                      tipo ? h('p', { className: 'post-card__category' },
                        h('span', { className: 'badge badge--category agenda-badge' }, String(tipo))
                      ) : null,
                      h('h2', { className: 'post-card__title' }, String(titulo)),
                      h('div', { className: 'post-card__meta agenda-meta' },
                        h('time', { dateTime: String(fecha) }, String(fecha || '')),
                        hora ? h('span', null, ' ' + String(hora)) : null,
                        (plaza || ciudad) ? h('span', null, ' ' + [String(plaza||''), String(ciudad||'')].filter(Boolean).join(' · ')) : null
                      )
                    )
                  )
                )
              );
            });
          } else {
            nodes.push(h('p', null, 'Añade festejos para previsualizar la agenda.'));
          }
          return h('div', { className: 'preview-root' }, nodes);
        }
      });
      CMS.registerPreviewTemplate('agenda-file', AgendaPreview);
    }
  </script>

  <!-- Auto-hide loader script -->
  <script>
    (function() {
      const ncRoot = document.getElementById('nc-root');
      if (ncRoot) {
        // Función para ocultar loader
        const hideLoader = () => {
          document.body.classList.add('cms-ready');
        };

        // Si ya tiene contenido (race condition), ocultar
        if (ncRoot.childNodes.length > 0) {
          hideLoader();
        } else {
          // Si no, observar cambios
          const observer = new MutationObserver((mutations) => {
            if (ncRoot.childNodes.length > 0) {
              hideLoader();
              observer.disconnect();
            }
          });
          observer.observe(ncRoot, { childList: true });
        }
      }
    })();
  </script>

</body> 
</html>