<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Andanada del 5 · CMS</title>
  <meta name="robots" content="noindex">
  <link rel="icon" type="image/png" href="../media/img/faviconandanada.png">
  
  <!-- Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(1200px 600px at 20% 10%, #1a1a1a, #0b0b0b 60%, #000 100%);
      color: #fff;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #nc-root {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loading-text {
      font-size: 14px;
      letter-spacing: .08em;
      text-transform: uppercase;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="nc-root">
    <p class="loading-text">Cargando panel editorial…</p>
  </div>

  <!-- Decap CMS Script -->
  <script src="https://unpkg.com/decap-cms@^3/dist/decap-cms.js"></script>
  
  <!-- Identity Redirect Script -->
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", function(user) {
        if (!user) {
          window.netlifyIdentity.on("login", function() {
            document.location.href = "/admin/";
          });
        }
      });
    }

    // Timeout Check
    setTimeout(function() {
      var loadingText = document.querySelector('.loading-text');
      if (loadingText) {
        loadingText.innerText = "No se ha podido cargar el CMS. Revisa conexión o configuración.";
      }
    }, 10000);
  </script>

  <script>
    // Custom Previews
    if (typeof CMS !== 'undefined') {
      CMS.registerPreviewStyle("../assets/css/styles.css");
      CMS.registerPreviewStyle(`
        :root {
          --preview-bg: #f6f6f6;
        }
        body {
          background: var(--preview-bg);
        }
        .preview-root {
          max-width: 980px;
          margin: 0 auto;
          padding: 24px 16px 40px;
        }
      `, { raw: true });

      var PostPreview = createClass({
        render: function () {
          var entry = this.props.entry;
          var getAsset = this.props.getAsset;
          var title = entry.getIn(['data','title']) || '';
          var date = entry.getIn(['data','date']) || '';
          var category = entry.getIn(['data','category']) || '';
          var excerpt = entry.getIn(['data','excerpt']) || '';
          var imagePath = entry.getIn(['data','image']);
          var image = imagePath ? getAsset(imagePath) : null;
          return h('div', { className: 'preview-root' },
            h('article', { className: 'post-card' },
              h('a', { className: 'post-card__link', href: '#' },
                h('div', { className: 'post-card__media post-card__media--ratio' },
                  image ? h('picture', null,
                    h('img', {
                      className: 'post-card__image',
                      src: image.toString(),
                      alt: 'Imagen del artículo: ' + String(title)
                    })
                  ) :
                  h('div', { className: 'skeleton skeleton-block', style: { height: '240px', borderRadius: '12px' } })
                ),
                h('div', { className: 'post-card__body' },
                  h('p', { className: 'post-card__category' },
                    h('span', { className: 'badge badge--category' }, String(category))
                  ),
                  h('h2', { className: 'post-card__title' }, String(title)),
                  h('div', { className: 'post-card__meta' },
                    h('time', { dateTime: String(date) }, String(date ? new Date(date).toLocaleDateString('es-ES') : ''))
                  ),
                  h('p', { className: 'post-card__excerpt' }, String(excerpt || 'Añade una entradilla para ver aquí un avance del contenido.'))
                )
              )
            )
          );
        }
      });
      CMS.registerPreviewTemplate('posts', PostPreview);

      var AgendaPreview = createClass({
        render: function () {
          var entry = this.props.entry;
          var getAsset = this.props.getAsset;
          var items = entry.getIn(['data','items']) || [];
          var nodes = [];
          if (items && items.size) {
            items.forEach(function (it, idx) {
              var titulo = it.get('titulo') || '';
              var tipo = it.get('tipo') || '';
              var fecha = it.get('fecha') || '';
              var hora = it.get('hora') || '';
              var plaza = it.get('plaza') || '';
              var ciudad = it.get('ciudad') || '';
              var posterPath = it.get('poster');
              var poster = posterPath ? getAsset(posterPath) : null;
              nodes.push(
                h('article', { key: String(idx), className: 'post-card agenda-card', style: { marginBottom: '16px' } },
                  h('div', { className: 'post-card__link' },
                    h('div', { className: 'post-card__media post-card__media--ratio' },
                      poster ? h('picture', null,
                        h('img', {
                          className: 'post-card__image',
                          src: poster.toString(),
                          alt: 'Cartel: ' + String(titulo)
                        })
                      ) :
                      h('div', { className: 'agenda-poster-placeholder' }, 'Cartel pendiente')
                    ),
                    h('div', { className: 'post-card__body' },
                      tipo ? h('p', { className: 'post-card__category' },
                        h('span', { className: 'badge badge--category agenda-badge' }, String(tipo))
                      ) : null,
                      h('h2', { className: 'post-card__title' }, String(titulo)),
                      h('div', { className: 'post-card__meta agenda-meta' },
                        h('time', { dateTime: String(fecha) }, String(fecha || '')),
                        hora ? h('span', null, ' ' + String(hora)) : null,
                        (plaza || ciudad) ? h('span', null, ' ' + [String(plaza||''), String(ciudad||'')].filter(Boolean).join(' · ')) : null
                      )
                    )
                  )
                )
              );
            });
          } else {
            nodes.push(h('p', null, 'Añade festejos para previsualizar la agenda.'));
          }
          return h('div', { className: 'preview-root' }, nodes);
        }
      });
      CMS.registerPreviewTemplate('agenda-file', AgendaPreview);
    }
  </script>
</body>
</html>
